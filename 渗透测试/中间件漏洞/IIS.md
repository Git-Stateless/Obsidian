# IIS 中间件漏洞

## IIS6.0 PUT漏洞

IIS6.0 server在web服务扩展中开启了WebDAV（Web-based Distributed Authoring and Versioning）。WebDAV是一种HTTP1.1的扩展协议。它扩展了HTTP 1.1，在GET、POST、HEAD等几个HTTP标准方法以外添加了一些新的方法，如PUT，使应用程序可对Web Server直接读写，并支持写文件锁定(Locking)及解锁(Unlock)，还可以支持文件的版本控制。可以像在操作本地文件夹一样操作服务器上的文件夹，该扩展也存在缺陷，利用PUT方法可直接向服务器上传恶意文件，控制服务器。

利用条件：
1. 开起来WebDAV
2. IIS配置了可以写入的权限

利用方法：
PUT / MOVE 的往服务器中传后门文件

## IIS 短文件名枚举漏洞
漏洞产生的原因是为了兼容MS-DOS程序，windows为文件名较长的文件生成了对应的windows 8.3的短文件名，攻击者可通过短文件名猜解对应的文件，访问下载敏感资源，绕过某些限制

dir /x一下可以看到短文件名长什么样

![](Pasted%20image%2020210607223514.png)

倒数第二列就是短文件名

短文件名是有一定规则的：

1.只有前六位字符直接显示，后续字符用~1指代。其中数字1还可以递增，如果存在多个文件名类似的文件（名称前6位必须相同，且后缀名前3位必须相同）；

2.后缀名最长只有3位，多余的被截断，超过3位的长文件会生成短文件名；

3.所有小写字母均转换成大写字母；

4.长文件名中含有多个“.”，以文件名最后一个“.”作为短文件名后缀；

5.长文件名前缀/文件夹名字符长度符合0-9和Aa-Zz范围且需要大于等于9位才会生成短文件名，如果包含空格或者其他部分特殊字符，不论长度均会生成短文件；

IIS8.0以下版本需要开启asp.net支持，IIS8.0及以上可不需要asp.net，转用OPTIONS与TRACE方法猜解

![](Pasted%20image%2020210607223716.png)

漏洞利用工具：
[lijiejie/IIS_shortname_Scanner: an IIS shortname Scanner](https://github.com/lijiejie/IIS_shortname_Scanner)

漏洞修复：
1. 关闭对NTFS对8.3文件名格式的支持
2. 禁用ASP.NET功能
3. 禁止在URL中使用 “~” 及其 Unicode 编码

## IIS解析漏洞
### IIS6.0

随着Windows Server 2003的停止维护，IIS 6.0的利用范围也在大幅度缩小。目前，新版的IIS中已不存在解析漏洞。这里仅以6.0环境作为漏洞利用场景来分析解析漏洞的综合利用方式。在解析asp格式的时候有两个解析漏洞：
1）当目录名包含`.asp .asa .cer .cdx`字符串，那么这个目录下所有的文件都会按照asp格式解析，因为IIS配置文件中默认配置了这4个文件扩展名的文件由asp.dll来解析。例如，对于/xx.asp/xx.jpg（xx.jpg可替换为任意文本文件）, IIS 6.0会将xx.jpg解析为asp文件。
2）IIS在处理分号（;）的文件名时，会截断分号后面的部分，造成解析漏洞。只要文件名中含有“.asp;”，就会优先按asp来解析。例如，对于/xx.asp;.jpg（此处需抓包修改文件名）, IIS 6.0都会把此类后缀文件成功解析为asp文件。（/xx.asp;.jpg这类文件在Windows下不允许存在，;.jpg被自动除去，剩下/xx.asp。）

IIS 6.0默认的可执行文件除了asp还包含如下三种：`/xx.asa、/xx.cer、/xx.cdx`（在IIS默认配置中，这几个后缀默认由asp.dll来解析，所以执行权限和．asp一模一样，可在配置中自行删除该后缀，以免出现安全隐患。）

修复建议：
1. 限制创建目录的名称
2. 限制创建文件名带有asp;的文件
3. 升级到最新版本

### IIS 7.0/IIS 7.5

IIS 7.0/7.5存在的解析漏洞利用场景比IIS 6.0要苛刻，主要是在对php解析时存在类似于Nginx的解析漏洞，并且需要处于[PHP CGI 解析漏洞](PHP%20CGI%20解析漏洞.md)Fast-CGI开启状态。在漏洞利用方式上，只要在任意文件名的URL后追加字符串“/任意文件名．php”，那么当前文件就会按照php的方式解析。

利用方法如下：将一张图和一个写入后门代码的文本文件合并，将恶意文本写入图片的二进制代码之后，避免破坏图片文件头和尾。Windows下可利用CMD命令实现文件拼接：

`copy xx.jpg /b + yy.txt /a xy.jpg`

其中，参数的意义为：
● /b二进制（binary）模式。
● /a ASCII模式xx.jpg正常图片文件。
● yy.txt的内容如下：

`<? PHP fputs(fopen('shell.php','w'),'<? PHP eval($_POST[cmd]?>');>`

执行成功后的效果就是在上传文件的真实目录下生成一句话木马文件shell.php，再利用各类连接工具连接即可完成整体漏洞利用。需要注意的是，IIS 7.0/7.5下的解析漏洞是由于[PHP CGI 解析漏洞](PHP%20CGI%20解析漏洞.md)PHP-CGI本身的问题导致，与IIS自身并没有直接关系。

修复建议：
1. 在“处理程序映射”界面的列表中双击FastCGI行，在弹出的“编辑模块映射”对话框中单击“请求限制”按钮，在弹出的“请求限制”对话框的“映射”选项卡中选择“文件货文件夹”单选按钮即可。
2. 修改 PHP 配置文件，设置 cgi.fix_pathinfo=0 。修改完后保存配置文件，然后重启IIS服务器。